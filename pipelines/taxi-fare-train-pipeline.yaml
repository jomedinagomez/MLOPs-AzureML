$schema: https://azuremlschemas.azureedge.net/latest/pipelineJob.schema.json
type: pipeline
experiment_name: nyc-taxi-pipeline-class-dev
description: Train Classification model based on nyc taxi dataset for the dev environment

# Notes:
# - These jobs currently use MLflow models. Later you can switch to a custom artifact flow.
# - To keep inputs minimal, we derive names in jobs and add a short artifact identifier:
#   artifact_id: 'm' for MLflow (now), 'c' for custom (later).
# - We apply artifact_id only to register/deploy names so training/comparison remain unchanged.

# <inputs_and_outputs>
inputs:
  # environment identifier for this pipeline config
  environment: 'dev'
  # model name
  model_base: 'taxi-class'
  # artifact identifier for naming: 'm' (MLflow now), 'c' (custom later)
  artifact_id: 'm'
  deployment_name: 'green'
  registry: 'mlrdevcc01'
  # compute cluster for automl job
  automl_compute: 'aml-cluster-dev-cc01'
outputs: 
  pipeline_job_trained_model:
    mode: rw_mount
  pipeline_job_predictions:
    mode: rw_mount
  pipeline_job_score_report:
    mode: rw_mount
  pipeline_job_comparison:
    mode: rw_mount

# </inputs_and_outputs>

settings:
  default_datastore: azureml:workspaceblobstore
  # All jobs use this compute unless overridden at the job level. To change, edit this value.
  default_compute: azureml:aml-cluster-dev-cc01
  continue_on_step_failure: false

jobs:
  merge_job:
    type: command
    code: ../src/merge_data
    command: >-
      python merge_data.py
      --raw_data_green ${{inputs.raw_data_green}}
      --raw_data_yellow ${{inputs.raw_data_yellow}}
      --merged_data ${{outputs.merged_data}}
    inputs:
      raw_data_green:
        type: uri_file 
        path: ../data/taxi-data/raw/greenTaxiData.csv
      raw_data_yellow:
        type: uri_file 
        path: ../data/taxi-data/raw/yellowTaxiData.csv
    outputs:
      merged_data:
        mode: upload
    environment: azureml:AzureML-sklearn-1.0-ubuntu20.04-py38-cpu@latest

  transform_job:
    type: command
    component: ../src/components/transform.yaml
    inputs:
      test_split_ratio: 0.3
      clean_data: ${{parent.jobs.merge_job.outputs.merged_data}}
    outputs:
      train_data:
      test_data: 

  train_job:
    type: command
    component: ../src/components/train.yaml
    inputs:
      training_data: ${{parent.jobs.transform_job.outputs.train_data}}
      testing_data: ${{parent.jobs.transform_job.outputs.test_data}}
      model_name: '${{parent.inputs.model_base}}-${{parent.inputs.environment}}'
      automl_compute: ${{parent.inputs.automl_compute}}
    outputs:
      model_output: ${{parent.outputs.pipeline_job_trained_model}}

  predict_job:
    type: command
    component: ../src/components/predict.yaml
    inputs:
      model_input: ${{parent.jobs.train_job.outputs.model_output}}
      test_data: ${{parent.jobs.transform_job.outputs.test_data}}
    outputs:
      predictions: ${{parent.outputs.pipeline_job_predictions}}

  compare_job:
    type: command
    component: ../src/components/compare.yaml
    inputs:
      model_input: ${{parent.jobs.train_job.outputs.model_output}}
      test_data: ${{parent.jobs.transform_job.outputs.test_data}}
      predictions: ${{parent.jobs.predict_job.outputs.predictions}}
      model_name: '${{parent.inputs.model_base}}-${{parent.inputs.environment}}'
    outputs:
      compare_output: ${{parent.outputs.pipeline_job_comparison}}
    
  score_job:
    type: command
    component: ../src/components/score.yaml
    inputs:
      predictions: ${{parent.jobs.predict_job.outputs.predictions}}
      model: ${{parent.jobs.train_job.outputs.model_output}}
    outputs:
      score_report: ${{parent.outputs.pipeline_job_score_report}}

  registerws_job:
    type: command
    component: ../src/components/register.yaml
    inputs:
      model_input: ${{parent.jobs.train_job.outputs.model_output}}
      # model name with artifact identifier (MLflow='m', custom='c')
      model_name: '${{parent.inputs.model_base}}-${{parent.inputs.environment}}-${{parent.inputs.artifact_id}}'
      compare_output: ${{parent.jobs.compare_job.outputs.compare_output}}
    outputs:
      register_output:

  registerex_job:
    type: command
    component: ../src/components/register.yaml
    inputs:
      model_input: ${{parent.jobs.train_job.outputs.model_output}}
      # model name with artifact identifier (MLflow='m', custom='c')
      model_name: '${{parent.inputs.model_base}}-${{parent.inputs.environment}}-${{parent.inputs.artifact_id}}'
      registry: ${{parent.inputs.registry}}
      compare_output: ${{parent.jobs.compare_job.outputs.compare_output}}
    outputs:
      register_output:

  deployex_job:
    type: command
    component: ../src/components/deploy.yaml
    inputs:
      # names include artifact_id (MLflow='m', custom='c') to distinguish implementations
      model_name: '${{parent.inputs.model_base}}-${{parent.inputs.environment}}-${{parent.inputs.artifact_id}}'
      endpoint_name: '${{parent.inputs.model_base}}-ex-${{parent.inputs.environment}}-${{parent.inputs.artifact_id}}'
      deployment_name: ${{parent.inputs.deployment_name}}
      registry: ${{parent.inputs.registry}}
      register_job_status: ${{parent.jobs.registerex_job.outputs.register_output}}

  deployws_job:
    type: command
    component: ../src/components/deploy.yaml
    inputs:
      # names include artifact_id (MLflow='m', custom='c') to distinguish implementations
      model_name: '${{parent.inputs.model_base}}-${{parent.inputs.environment}}-${{parent.inputs.artifact_id}}'
      endpoint_name: '${{parent.inputs.model_base}}-ws-${{parent.inputs.environment}}-${{parent.inputs.artifact_id}}'
      deployment_name: ${{parent.inputs.deployment_name}}
      register_job_status: ${{parent.jobs.registerws_job.outputs.register_output}}