# Azure ML Registry Infrastructure Module

This Terraform module deploys an Azure Machine Learning Registry with private network connectivity, monitoring, and RBAC configuration. The registry enables centralized model and component sharing across multiple Azure ML workspaces.

## üéØ **Module Overview**

This module creates a secure, centralized Azure ML Registry featuring:

- **üìö ML Registry**: Central repository for models, components, and environments
- **üîí Private Connectivity**: Private endpoint for secure access from workspaces
- **üìä Monitoring**: Log Analytics workspace for registry operations monitoring  
- **üÜî System Identity**: System-assigned managed identity for registry operations
- **üë• RBAC Integration**: Role assignments for users and compute identities
- **üåê DNS Integration**: Proper DNS resolution for private endpoints

## üèóÔ∏è **Architecture**

```mermaid
graph TB
    subgraph "User-Managed Resource Group: rg-aml-reg-{environment}-{location-code}"
        subgraph "Core Registry"
            REG[Azure ML Registry<br/>System-Assigned Identity]
            LA[Log Analytics Workspace<br/>Registry Monitoring]
        end
        
        subgraph "Private Connectivity"
            PE[Registry Private Endpoint<br/>privatelink.api.azureml.ms]
            DNS[DNS A Record<br/>Registry Resolution]
        end
        
        subgraph "RBAC Configuration"
            UR[User Registry Access<br/>Registry User Role]
            MIR[Managed Identity Access<br/>Compute Cluster Access]
        end
        
        REG --> PE
        PE --> DNS
        REG -.-> LA
    end
    
    subgraph "Microsoft-Managed Resource Group: rg-{registry-name}"
        MGT[Internal Registry Components<br/>‚ö†Ô∏è Do Not Modify]
        STOR[System Storage Account<br/>Auto-managed by Azure]
        ACR[System Container Registry<br/>Auto-managed by Azure]
        
        REG -.-> MGT
        MGT --> STOR
        MGT --> ACR
    end
    
    subgraph "External Dependencies"
        VNet[VNet from aml-vnet module]
        DNSZone[Private DNS Zone<br/>privatelink.api.azureml.ms]
        WS[ML Workspaces<br/>Registry Consumers]
    end
    
    PE -.-> VNet
    DNS -.-> DNSZone
    REG -.-> WS
```

### **‚ö†Ô∏è Important: Microsoft Managed Resource Groups**

When you deploy an Azure ML Registry, Azure automatically creates a **Microsoft managed resource group** containing internal infrastructure components:

- **Resource Group Name**: `rg-{registry-name}` (auto-generated by Azure)
- **Contains**: System storage account, container registry, and other internal components
- **Management**: Fully managed by Microsoft - **NEVER modify, delete, or manage these resources**
- **Lifecycle**: Created automatically when registry deploys, removed when registry is deleted
- **Permissions**: You'll see this resource group in your subscription but should not interact with it

> üõë **Critical Warning**: Modifying or deleting resources in the Microsoft managed resource group (`rg-{registry-name}`) will break your ML Registry and may require Microsoft support to resolve. Always work only with the user-managed resource group (`rg-aml-reg-{environment}-{location-code}`).

## üìã **Required Configuration**

### **Critical Settings to Update**

This module depends on outputs from the `aml-vnet` module. When using the root orchestration, these dependencies are automatically resolved.

#### 1. **User Identity Configuration** üë§
```hcl
# Your Azure AD user object ID for registry access
user_object_id = "12345678-1234-1234-1234-123456789012"
```

**Get your user object ID:**
```bash
az ad signed-in-user show --query id -o tsv
```

#### 2. **Network Dependencies** üåê
```hcl
# From aml-vnet module outputs (automatically provided in orchestrated deployment)
subnet_id = "/subscriptions/{sub}/resourceGroups/{resource-group-name}/providers/Microsoft.Network/virtualNetworks/{vnet-name}/subnets/{subnet-name}"

# DNS zone resource group (from aml-vnet module)  
resource_group_name_dns = "{resource-group-name}"

# VNet location for private endpoint
workload_vnet_location = "canadacentral"
workload_vnet_location_code = "cc"
```

#### 3. **Managed Identity Access** üÜî
```hcl
# Compute cluster identity for registry access (from aml-vnet module)
compute_cluster_identity_principal_id = "87654321-4321-4321-4321-210987654321"
```

#### 4. **Environment Configuration** ‚öôÔ∏è
```hcl
# Environment and location settings
purpose = "dev"                    # Environment identifier
location = "canadacentral"         # Azure region for registry
location_code = "cc"              # Short region code
random_string = "001"             # Unique identifier

# Azure subscription
sub_id = "your-subscription-id"   # Target subscription
```

## üîë **RBAC Configuration**

### **User Registry Access**
| Role | Scope | Purpose |
|------|-------|---------|
| `AzureML Registry User` | Registry | Access models, components, and environments |

### **Managed Identity Access** 
| Role | Scope | Purpose |
|------|-------|---------|
| `AzureML Registry User` | Registry | Allow compute clusters to access shared assets |

## üì¶ **Registry Features**

### **Asset Types Supported**
- **Models**: Trained ML models with metadata and versioning
- **Components**: Reusable pipeline components and scripts
- **Environments**: Standardized runtime environments for training and inference
- **Data Assets**: Shared datasets and data references

### **Private Network Integration**
- **Private Endpoint**: Secure access via `privatelink.api.azureml.ms`
- **DNS Resolution**: Automatic DNS A record creation for private endpoint
- **VNet Integration**: Seamless connectivity from ML workspaces in same VNet

### **Monitoring & Logging**
- **Log Analytics**: Dedicated workspace for registry operations
- **Activity Logging**: Track registry access and modifications
- **Diagnostics**: Enable detailed logging for troubleshooting

## üîß **Usage Examples**

### **Accessing Registry from Workspace**
```python
from azure.ai.ml import MLClient
from azure.identity import DefaultAzureCredential

# Connect to registry
ml_client = MLClient(
    credential=DefaultAzureCredential(),
    registry_name="{registry-name}"
)

# List available models
models = ml_client.models.list()
for model in models:
    print(f"Model: {model.name}, Version: {model.version}")
```

### **Sharing Models via Registry**
```python
# Register model to registry
ml_client.models.create_or_update(
    model=Model(
        name="taxi-fare-model",
        path="./model",
        description="Taxi fare prediction model"
    )
)
```

## üöÄ **Deployment Considerations**

### **Performance**
- **Region Placement**: Deploy registry in same region as primary workspaces
- **Network Latency**: Private endpoints provide low-latency access
- **Caching**: Registry caches frequently accessed assets

### **Security**
- **Private Access Only**: No public endpoint access
- **Identity-Based Auth**: Uses Azure AD for authentication
- **Network Isolation**: Traffic stays within private network

### **Scalability**
- **Multi-Workspace**: Single registry can serve multiple workspaces
- **Version Management**: Automatic versioning of all assets
- **Global Replication**: Can replicate to other regions if needed

## Optional Customizations

### Location and Naming
- `location`: Azure region for resources (default: canadacentral)
- `location_code`: Short code for the region (e.g., "cc" for Canada Central)
- `purpose`: Environment identifier (e.g., "dev", "test", "prod")
- `random_string`: Unique identifier to ensure resource name uniqueness

### Tags
Customize the `tags` section to match your organization's tagging strategy.

## Architecture

This module creates the following Azure resources:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                   Resource Group                        ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ            Azure ML Registry                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ  - System-assigned managed identity                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ  - Private network access only                      ‚îÇ ‚îÇ
‚îÇ ‚îÇ  - System-managed storage (Standard_LRS)            ‚îÇ ‚îÇ
‚îÇ ‚îÇ  - System-managed ACR (Premium SKU)                 ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                         ‚îÇ
‚îÇ  Supporting Services:                                   ‚îÇ
‚îÇ  - Log Analytics Workspace (monitoring)                 ‚îÇ
‚îÇ  - Private Endpoint (secure connectivity)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## Security Features

- **Network Isolation**: Registry accessible only via private endpoint
- **System-Managed Identity**: Automatic identity management for registry operations
- **Private Endpoint**: Secure connectivity from your VNet
- **Premium ACR**: High-performance container registry with security features
- **Monitoring**: Log Analytics integration for audit and monitoring

## Role Assignments

The module automatically creates the following role assignments:

**User Account:**
- Azure AI Developer (Registry scope)
- AzureML Registry User (Registry scope)

**Registry System Identity:**
- Contributor (Resource Group scope) - for managing system resources

## Prerequisites

- Azure CLI installed and authenticated
- Terraform >= 1.0 installed
- Existing VNet and subnet for private endpoints
- Private DNS zones configured and linked to your VNet (deployed via `aml-vnet` module)
- Appropriate Azure RBAC permissions to create resources
- Azure subscription with sufficient quota for ML resources

## Deployment Steps

1. **Initialize Terraform:**
```bash
terraform init
```

2. **Review and customize terraform.tfvars:**
```bash
# Copy the example file and customize
cp terraform.tfvars.example terraform.tfvars
# Edit terraform.tfvars with your specific values
```

3. **Plan the deployment:**
```bash
terraform plan
```

4. **Apply the configuration:**
```bash
terraform apply
```

5. **Verify deployment:**
```bash
# Check registry status
az ml registry show --name <registry-name> --resource-group <resource-group>

# List registry models (if any)
az ml model list --registry-name <registry-name>
```

## Post-Deployment Configuration

### Configure Registry Access
After deployment, the registry is accessible only via private endpoint from your VNet:

1. **Verify Private Endpoint Connectivity:**
```bash
# Test DNS resolution from a VM in your VNet
nslookup <registry-name>.privatelink.api.azureml.ms
```

2. **Connect from Azure ML Workspace:**
```bash
# Register the registry in your workspace
az ml registry connect --name <registry-name> --workspace-name <workspace-name>
```

## Resources Created

This module creates the following Azure resources:

### **User-Managed Infrastructure** (`rg-aml-reg-{environment}-{location-code}`)
- **Resource Group**: Container for user-managed registry resources
- **Log Analytics Workspace**: Centralized logging and monitoring
- **Azure ML Registry**: Main registry for models, components, and environments
- **Private Endpoint**: Secure connectivity to the registry
- **Role Assignments**: Proper RBAC for users and system identity

### **Microsoft-Managed Infrastructure** (`rg-{registry-name}` - Auto-created)
- **System Storage Account**: Automatic storage (Standard_LRS, HNS disabled) - **Do not modify**
- **System Container Registry**: Automatic ACR (Premium SKU) - **Do not modify**
- **Internal Components**: Other Azure-managed infrastructure - **Do not modify**

> ‚ö†Ô∏è **Important**: The Microsoft-managed resource group is automatically created by Azure and contains system-level infrastructure. You will see this resource group in your subscription, but you should never interact with, modify, or delete these resources as it will break the ML Registry functionality.

## Outputs

The module provides the following outputs:

- `registry_name`: Name of the created ML registry
- `registry_id`: Full resource ID of the ML registry
- `resource_group_name`: Name of the created resource group
- `log_analytics_workspace_name`: Name of the Log Analytics workspace
- `registry_identity_principal_id`: Principal ID of the registry's system identity

## Troubleshooting

### Common Issues

1. **DNS Resolution Issues:**
   - Ensure private DNS zones are properly linked to your VNet
   - Verify DNS zone name matches exactly: `privatelink.api.azureml.ms`

2. **Permission Errors:**
   - Check if your user has sufficient RBAC permissions
   - Verify registry identity role assignments

3. **Network Connectivity:**
   - Confirm subnet has sufficient IP addresses
   - Check private endpoint connectivity and DNS resolution
   - Verify private DNS zones are properly linked to VNet

### Useful Commands

```bash
# Check private endpoint status
az network private-endpoint list --resource-group <resource-group>

# Verify DNS resolution
nslookup <registry-name>.privatelink.api.azureml.ms

# Check role assignments
az role assignment list --scope <registry-resource-id>

# Test registry connectivity
az ml registry show --name <registry-name>
```

## üîß Troubleshooting

### **Common Deployment Issues**

#### **Registry Creation Conflicts**

**Issue**: Registry deployment fails due to soft-deleted Azure resources.

**Note**: While this module doesn't directly create Key Vaults, it depends on the workspace module which does. If you're seeing Key Vault conflicts:

**Solution**: Purge any soft-deleted Key Vaults before deploying the entire infrastructure:
```bash
# Check for soft-deleted Key Vaults that might conflict
az keyvault list-deleted --query "[].{Name:name, Location:properties.location}" --output table

# Purge if needed (coordinate with workspace module deployment)
az keyvault purge --name kvdevcc002 --location canadacentral
```

#### **Private Endpoint Connectivity**

**Issue**: Registry not accessible from workspace through private endpoint.

**Solutions**:
- Verify DNS zone links exist: `az network private-dns zone list --resource-group {dns-rg}`
- Check private endpoint approval: `az network private-endpoint list --resource-group {registry-rg}`
- Validate outbound rules in workspace managed VNet

#### **RBAC Permission Issues**

**Issue**: Users or compute clusters cannot access registry.

**Solutions**:
- Verify role assignments: `az role assignment list --scope {registry-id}`
- Check managed identity principal IDs match workspace compute
- Ensure proper dependency chain between workspace and registry modules

### **Diagnostic Commands**

```bash
# Check registry status
az ml registry show --name {registry-name} --resource-group {resource-group}

# Verify private endpoint connections
az network private-endpoint list --resource-group {resource-group} --query '[].{Name:name, State:privateLinkServiceConnections[0].privateLinkServiceConnectionState.status}'

# Monitor registry logs
az monitor activity-log list --resource-group {resource-group} --start-time {start-time}

# Check DNS resolution
nslookup {registry-name}.api.azureml.ms
```

### **Cleanup Considerations**

‚ö†Ô∏è **Important**: This registry may contain valuable ML assets (models, components, environments).

**Before cleanup**:
1. Export/backup important models and components
2. Coordinate with teams using shared registry
3. Verify no production workspaces depend on registry assets

## Clean Up

To remove all resources:

```bash
terraform destroy
```

**Warning**: This will permanently delete the registry including any models, components, or environments stored in it.

## Dependencies

This module depends on:
- `aml-vnet` module for networking infrastructure and private DNS zones
- Existing Azure subscription with proper quotas
- VNet and subnet for private endpoint connectivity

## Module Structure

```
aml-registry-smi/
‚îú‚îÄ‚îÄ main.tf                 # Main Terraform configuration
‚îú‚îÄ‚îÄ variables.tf            # Variable definitions
‚îú‚îÄ‚îÄ outputs.tf              # Output definitions
‚îú‚îÄ‚îÄ locals.tf               # Local value definitions
‚îú‚îÄ‚îÄ data.tf                 # Data source definitions
‚îú‚îÄ‚îÄ terraform.tfvars        # Configuration values
‚îú‚îÄ‚îÄ providers.tf            # Provider configuration
‚îú‚îÄ‚îÄ versions.tf             # Provider version constraints
‚îî‚îÄ‚îÄ README.md              # This documentation
```

## Related Modules

- **aml-vnet**: Creates VNet, subnets, and private DNS zones
- **aml-managed-smi**: Creates Azure ML workspace with managed VNet
- **modules/private-endpoint**: Shared module for private endpoint creation

## Best Practices

1. **Naming Convention**: Follow consistent naming patterns across all modules
2. **Network Security**: Use private endpoints for all ML services
3. **Access Control**: Implement least-privilege RBAC assignments
4. **Monitoring**: Enable Log Analytics for audit trails
5. **Resource Organization**: Use consistent tagging strategy
6. **Version Control**: Pin Terraform provider versions for stability
